Joshfire.define(["joshfire/utils/datasource","joshfire/vendor/underscore"],function(a,b){var c=new a;return{afpDataRoot:"http://media.aldune.com/ipad/",ignoreList:{modes:["sid"]},init:function(a){a(null,[])},proxy:function(a,b){return a.url?(a.data||(a.data={}),c.request({url:"/proxy",type:"POST",data:a,dataType:a.dataType||"json"},b),!0):(b("Proxy error: no url",null),!1)},getFolderList:function(a,c){var d=this,e=[];a||(a=d.afpDataRoot),d.proxy({url:a,dataType:"html"},function(a,f){if(a||!f)return console&&console.warn&&console.warn("Zero folder retrieved",a,f),c(null,e),!1;var g=f.match(/<tr>(.*)<\/tr>/g),h,i;return b.each(g,function(a){return h=a.match(/<td>(.*)<\/td>/g),!h||!h.length?!1:(i=/<a(?:[^href]*)href=(?:[^>]*)>(.*)<\/a>/g.exec(h[0]),i?i[1].toLowerCase()=="parent directory"||b.contains(d.ignoreList.folders,i[1])?!1:(e.push(i[1].replace(/\/$/,"")),!0):!1)}),c(null,e),!0})},filterFolders:function(a,c){var d=this,e=[];return b.each(a,function(a){return b.contains(d.ignoreList[c],a)?!1:(e.push(a),!0)}),e},getModes:function(a){var b=this,c=[];b.getFolderList(null,function(c,d){return c?(a(c,null),!1):(a(null,b.filterFolders(d,"modes")),!0)})},getModeDataURL:function(a){return this.afpDataRoot+a+"/journal"},getCategoriesFromFolder:function(a,b){var c=this,d=[];c.getFolderList(c.getModeDataURL(a),function(a,d){return a?(b(a,null),!1):(b(null,c.filterFolders(d,"categs")),!0)})},getCategories:function(a,d){var e=this;c.request({url:"/data/categories.xml",dataType:"xml"},function(a,c){if(a||!c)return d(a||"no categs",null),!1;var e=[],f=c.getElementsByTagName("categorie"),g,h,i;b.each(f,function(a,b){g=a.getElementsByTagName("id"),h=a.getElementsByTagName("name"),i=a.getElementsByTagName("url"),e.push({id:g&&g.length?g[0].firstChild.nodeValue:b,label:h&&h.length?h[0].firstChild.nodeValue:"",url:i&&i.length?i[0].firstChild.nodeValue:null})});var j=e.splice(10);return e=[e[9]].concat(e.splice(0,9)).concat(j),d(null,e),!0})},getNewsList:function(a,c,d,e){var f=this,g=[];b.isArray(c)||(c=[c]);var h=b.after(c.length,function(){d(null,g)});b.each(c,function(c){f.proxy({url:f.getModeDataURL(a)+"/"+c.id,dataType:"xml"},function(d,i){if(d||!i)return console&&console.warn&&console.warn("couldnt retrieve news",a,c.label,d,i),h(d,null),!1;var j=i.documentElement,k=(new Date(f.formatDate(j.getElementsByTagName("DateAndTime")[0].firstChild.nodeValue))).getTime();if(c.lastUpdate&&c.lastUpdate==k)return console&&console.log&&console.log(c.label,"nothing new still",(new Date(k)).toString()),g=g.concat(c.news),h();var l=j.getElementsByTagName("NewsItemRef"),m=b.after(l.length,function(){h()}),n=0;return b.each(l,function(d,h){f.getNewsDetails({mode:a,categ:c.id,url:d.getAttribute("NewsItem")},function(d,h){h.image&&h.image.preview&&h.image.preview.src&&(h.image.preview.src=h.image.preview.src.replace(/@@prefix@@/,f.getModeDataURL(a)+"/"+c.id+"/")),h.image&&h.image.square&&h.image.square.src&&(h.image.square.src=h.image.square.src.replace(/@@prefix@@/,f.getModeDataURL(a)+"/"+c.id+"/")),g.push(b.extend({categ:c.id,categUpdate:k},h)),n++==0&&typeof e=="function"&&e(null,h),m()})}),!0})})},getNewsDetails:function(a,b){var c=this,d=c.getModeDataURL(a.mode)+"/"+a.categ+"/"+a.url;c.proxy({url:d,dataType:"xml"},function(a,d){return a||!d?(b(a||"no details",null),!1):(b(null,c.parseNewsML(d.documentElement)),!0)})},parseNewsML:function(a){var c=this,d=c.getVoidNews(),e=a.getElementsByTagName("DescriptiveMetadata"),f=a.getElementsByTagName("NewsComponent"),g=a.getElementsByTagName("FirstCreated"),h=a.getElementsByTagName("ThisRevisionCreated"),i=a.getElementsByTagName("HeadLine");if(e.length){var j=e[0].getElementsByTagName("Location");if(j.length){d.location={};var k=j[0].getElementsByTagName("Property");b.each(k,function(a){d.location[a.getAttribute("FormalName").toLowerCase()]=a.getAttribute("Value"),d.location.latitude&&(d.location.lat=d.location.latitude,delete d.location.latitude),d.location.longitude&&(d.location.lng=d.location.longitude,delete d.location.longitude)})}}return g.length&&(d.createdDate=(new Date(c.formatDate(g[0].firstChild.nodeValue))).getTime()),h.length&&(d.updatedDate=(new Date(c.formatDate(h[0].firstChild.nodeValue))).getTime()),i.length&&(d.title=i[0].textContent),b.each(f,function(a,c){var e=a.getElementsByTagName("Role"),f=a.getElementsByTagName("DataContent"),g=a.getElementsByTagName("Party");if(!e.length)f.length&&(d.text=b.map(f[0].getElementsByTagName("p"),function(a){return"<p>"+(a.firstChild?a.firstChild.nodeValue:"")+"</p>"}).join(""));else switch(e[0].getAttribute("FormalName")){case"Caption":d.image||(d.image={preview:{},square:{},caption:null});if(d.image.caption)return!1;var h=function(a,b){return navigator.userAgent.indexOf("Large Screen")>0?"":a.length<b?a:a.substring(0,b-3)+"..."};d.image.caption=b.map(f[0].getElementsByTagName("p"),function(a){return a.firstChild?"<p>"+h(a.firstChild.nodeValue,250)+"</p>":""}).join("");break;case"Quicklook":break;case"Preview":d.image||(d.image={preview:{},square:{},caption:null});if(d.image.preview.src)return!1;f=a.getElementsByTagName("ContentItem");if(f.length){var i=f[0].getElementsByTagName("MediaType");if(i.length&&i[0].getAttribute("FormalName")=="Photo"){d.image.preview.src="@@prefix@@"+f[0].getAttribute("Href");var j=f[0].getElementsByTagName("Characteristics");j.length&&b.each(j[0].getElementsByTagName("Property"),function(a){d.image.preview[a.getAttribute("FormalName").toLowerCase()]=a.getAttribute("Value")})}}break;case"Squared120":d.image||(d.image={preview:{},square:{},caption:null});if(d.image.square.src)return!1;f=a.getElementsByTagName("ContentItem");if(f.length){var i=f[0].getElementsByTagName("MediaType");if(i.length&&i[0].getAttribute("FormalName")=="Photo"){d.image.square.src="@@prefix@@"+f[0].getAttribute("Href");var j=f[0].getElementsByTagName("Characteristics");j.length&&b.each(j[0].getElementsByTagName("Property"),function(a){d.image.square[a.getAttribute("FormalName").toLowerCase()]=a.getAttribute("Value")})}}break;case"HighDef":}}),d},formatDate:function(a){var b=/^([0-9]{4})([0-9]{2})([0-9]{2})T([0-9]{2})([0-9]{2})([0-9]{2})?(Z|([+-])([0-9]{2}):([0-9]{2}))?$/,c=a.match(b);return!c||c.length<8?!1:c[1]+"-"+c[2]+"-"+c[3]+" "+c[4]+":"+c[5]+":"+c[6]},getVoidNews:function(){var a={id:null,title:null,image:null,text:null,location:null,createdDate:null,updatedDate:null,author:null};return a}}});