Joshfire.define(["joshfire/app","joshfire/class","./tree.ui","./tree.data","joshfire/vendor/underscore","joshfire/utils/cookie","./async"],function(a,b,c,d,e,f,g){return b(a,{id:"geocontent-"+Joshfire.factory.config.app.id,defaultMode:"english",uiClass:c,dataClass:d,categsUIPath:"/header/menu/categories/list",refreshInterval:3e5,refreshItems:!1,newsShiftPeriod:1e4,categsScrollOffset:400,started:!1,paused:!1,setup:function(a){var b=this;b.__super(a),Joshfire.factory.config.app.name&&$("head title").text(Joshfire.factory.config.app.name),Joshfire.factory.config.app.icon&&Joshfire.factory.config.app.icon.contentURL&&$("head").append('<link rel="apple-touch-icon-precomposed" href="'+Joshfire.factory.config.app.icon.contentURL+'">'),Joshfire.factory.config.template.options.durAnimation&&(b.newsShiftPeriod=Joshfire.factory.config.template.options.durAnimation*1e3),Joshfire.factory.config.template.options.durRefresh&&(b.refreshInterval=Joshfire.factory.config.template.options.durRefresh*1e3);var c=b.ui.element("/map");Joshfire.factory.config.template.options.enable3D?(c.options.enable3D=!0,c.webGLEnabled=!0):(c.options.enable3D=!1,c.webGLEnabled=!1),Joshfire.factory.config.template.options.provider3D&&(c.options.mapOptions.provider3D=Joshfire.factory.config.template.options.provider3D),b.subscribe("afterInsert",function(){var a=b.ui.element("/header/menu/lang"),c=a.getState("selection").length?e.first(a.getState("selection")):b.defaultMode,d=b.ui.element(b.categsUIPath),g=b.ui.element("/header/menu/categories/rewind"),h=b.ui.element("/header/menu/categories/forward"),i=b.ui.element("/news"),j=b.ui.element("/map"),k=0;setTimeout(function(){!b.started&&d.data.length&&d.publish("data",null)},4e3),b.headerFoldingCountdownReset(b),$(window).bind("touchstart click MozTouchDown swipeLeft swipeRight swipeUp swipeDown",function(a){b.headerFoldingCountdownReset(b)}),$(document).bind("keypress",function(a){a.keyCode===32?b.toggleNewsCountdown():a.keyCode==="n".charCodeAt(0)||a.keyCode==="N".charCodeAt(0)?b.nextNews(b):a.keyCode==="s".charCodeAt(0)||a.keyCode==="S".charCodeAt(0)?(b.paused=!b.paused,b.toggleNewsCountdown()):b.headerFoldingCountdownReset(b)}),d.subscribe("data",function(a,g){b.started=!0;if(e.isEqual(d.data,d.savData))return;d.savData=d.data,i.setData([]);var h=JSON.parse(f("geocontent-"+Joshfire.factory.config.app.id+"-categs"));if(h&&h[c]&&h[c].length){var j=e.pluck(d.data,"id");h[c]=e.filter(h[c],function(a){return e.include(j,a)}),h[c].length>0?b.selectListItem(d,"id",h[c]):b.selectListItem(d,"index",0)}else b.selectListItem(d,"index",0)}),d.subscribe("select",function(a,g){var h=0;k+=1,h=k;var j=b.refreshItems,l=d.getState("selection");f("geocontent-"+Joshfire.factory.config.app.id+"-mode",c);var m=JSON.parse(f("geocontent-"+Joshfire.factory.config.app.id+"-categs"))||{};m[c]=l,f("geocontent-"+Joshfire.factory.config.app.id+"-categs",JSON.stringify(m)),i.dataCache||(i.dataCache={categs:[],news:[]});var n=e.map(l,function(a){return d.getDataById(a)});async.map(n,function(a,b){a.data&&!j?b(null,a.data):a.find({},function(c,d){d&&(d.entries=e.map(d.entries,function(b,c){return e.extend(b,{id:"#"+a.name+"-"+c,useContent:a.useContent})})),a.data=d,b(c,d)})},function(a,c){if(a)return b.startRefreshLoop(),!1;h===k&&(i.data=[],e.each(c,function(a){a.entries&&(i.data=i.data.concat(a.entries))}),b.refreshItems&&(b.refreshItems=!1,b.startRefreshLoop()),b.updateNews(b))})}),i.subscribe("afterRefresh",function(a,c){i.getState("selection").length||b.selectListItem(i,"index",0)}),i.subscribe("select",function(a,c){b.changeNews(b,c)}),g.subscribe("input",function(a,c){c&&c.length&&c[0]==="enter"&&b.listScroll(d,"left",b.categsScrollOffset)}),h.subscribe("input",function(a,c){c&&c.length&&c[0]=="enter"&&b.listScroll(d,"right",b.categsScrollOffset)})})},updateNews:function(a){var b=a.ui.element("/news"),c=a.ui.element(a.categsUIPath),d=c.getState("selection");b.data=a.getSortedNews(a);var f=b.data.length!==b.dataCache.news.length;if(!f){var g=e.find(b.data,function(a,c){return a.name!==b.dataCache.news[c].name});g&&(f=!0)}return f?(b.dataCache.news=b.data,b.dataCache.categs=e.extend([],d),typeof b.grid!="undefined"&&b.grid.setGrid([b.data]),b.refresh(),!0):!1},updateCategPicto:function(a,b){var c=this,d=c.ui.element(c.categsUIPath),e=null;return b.square&&b.square.src?e=b.square.src:b.preview&&b.preview.src&&(e=b.preview.src),e?(d.getDataById(a).image=e,d.refresh(),!0):!1},getSortedNews:function(a){var b=a.ui.element("/news").data,c=null;return Joshfire.factory.config.template.options.randomize?c=e.shuffle(b):c=e.sortBy(b,function(a){return a.datePublished||a.dateModified||a.dateCreated||a.uploadDate||a.startDate||a.endDate||a.datePosted||a.foundingDate||a.birthDate||a.deathDate}).reverse(),c},startRefreshLoop:function(){var a=this;a.refreshLoop&&a.stopRefreshLoop(),a.refreshLoop=setTimeout(function(){var b=a.ui.element(a.categsUIPath);a.refreshItems=!0,b.publish("select",[b.getState("selection")])},a.refreshInterval)},stopRefreshLoop:function(){var a=this;clearInterval(a.refreshLoop),a.refreshLoop=!1},startNewsCountdown:function(){var a=this;a.paused||(a.newsCountdown=setTimeout(function(){a.nextNews(a)},a.newsShiftPeriod))},stopNewsCountdown:function(){var a=this;return clearTimeout(a.newsCountdown),a.newsCountdown=!1,!1},toggleNewsCountdown:function(){var a=this;return a.newsCountdown?(a.stopNewsCountdown(),!1):(a.startNewsCountdown(),!0)},focusListItem:function(a,b,c){if(!a||a.type!="List")return!1;if(!a.data.length)return!1;c instanceof Array||(c=[c]);switch(b){case"id":var d=[];e.each(c,function(b){var c=a.getIndexById(b);c&&d.push(c)});if(!d.length)return!1;a.grid&&(a.grid.options.defaultPosition=[d[0],0],a.grid.currentCoords=a.grid.options.defaultPosition),a.focusById(c);break;default:e.each(c,function(b,d){b>=a.data.length&&c.splice(d,1)}),a.grid&&(a.grid.options.defaultPosition=[c[0],0],a.grid.currentCoords=a.grid.options.defaultPosition),a.focusByIndex(c)}return!0},selectListItem:function(a,b,c){if(!a||a.type!="List")return!1;if(!a.data.length)return!1;!c instanceof Array&&(c=[c]);switch(b){case"id":a.selectById(c);break;default:e.each(c,function(b,d){b>=a.data.length&&c.splice(d,1)}),a.selectByIndex(c)}return a.app.focusListItem(a,b,c),!0},changeNews:function(a,b){if(!b||!b.length)return!1;var c=a.ui.element("/news"),d=c.getDataById(b),f=a.ui.element("/map"),g=null,h={};if(!d)return!1;g=e.reduce(["contentLocation","location","homeLocation","workLocation","jobLocation",null],function(a,b){return a||(b?d[b]:d)},null),g&&g.geo&&g.geo.latitude&&g.geo.longitude?h={lat:g.geo.latitude,lng:g.geo.longitude}:g&&(h={lat:d["gsx:lat"]||d["gsx:latitude"],lng:d["gsx:lng"]||d["gsx:long"]||d["gsx:longitude"]});if(!h.lat||!h.lng)return a.nextNews(a),!1;a.ui.element("/detail").hide(),a.ui.element("/city").hide();var i={zoomTimer:Joshfire.adapter==="ios"?500:250,minZoom:3,clearMarkers:!0},j=e.extend({},h);return!f.webGLEnabled&&a.notFirstMove?(f.panTo(j),a.displayContent(h,function(){a.startNewsCountdown()})):(a.notFirstMove=!0,f.moveToLocation(j,i,function(){a.displayContent(h,function(){a.startNewsCountdown()})})),!0},nextNews:function(a){var b=a.ui.element("/news");return!b.data||!b.data.length?!1:(a.stopNewsCountdown(),!0)},displayContent:function(a,b){var c=this.ui.element("/map"),d=this.ui.element("/news"),e=d.getDataById(d.getState("selection"));return c.webGLEnabled?this.displayContentWebGL(a,b):this.displayContentClassic(a,b)},displayContentClassic:function(a,b){var c=this,d=c.ui.element("/map"),e=400,f=d.map,g=c.ui.element("/news"),h=c.ui.element("/detail"),i=c.ui.element("/city");h.data=g.getDataById(g.getState("selection")),h.refresh(),i.data=h.data,i.refresh(),setTimeout(function(){setTimeout(function(){var a=setInterval(function(){return d.getZoom()>=d.mapOptions.zoom?(clearInterval(a),c.fadeIn(h),c.fadeIn(i),b&&b(),!0):(d.setZoom(d.getZoom()+1),!1)},e)},e)},e)},fadeIn:function(a){var b=document.getElementById(a.htmlId),c=function(){b.style.opacity<1&&(b.style.opacity=Number(b.style.opacity)+.1,setTimeout(c,30))};b.style.opacity=0,a.show(),c()},displayContentWebGL:function(a,b){var c=this,d=c.ui.element("/map"),e=c.ui.element("/news"),f=c.ui.element("/detail"),g=c.ui.element("/city");f.data=e.getDataById(e.getState("selection")),g.data=f.data,f.refresh(),g.refresh(),c.fadeIn(f),c.fadeIn(g),b&&b();return},headerFoldingCountdownReset:function(a){var b=3e4,c=a.ui.element("/header");a.headerFoldingCountdown&&clearTimeout(a.headerFoldingCountdown),c.htmlEl.style.display==="none"&&c.show(),a.headerFoldingCountdown=setTimeout(function(){c.hide()},b)}})});